# روز پنجم - تسلط بر مجموعه‌های کاساندرا: لیست، ست و مپ با مثال‌های عملی

![لوگوی کاساندرا](https://img.shields.io/badge/Apache%20Cassandra-1287B1?style=flat&logo=apache-cassandra&logoColor=white)
[![مجوز: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![ستاره‌های گیت‌هاب](https://img.shields.io/github/stars/mrkeshi/cassandra-journey-10days?style=social)](https://github.com/mrkeshi/cassandra-journey-10days)

به **روز پنجم** از سفر یادگیری آپاچی کاساندرا خوش آمدید! 🎉 امروز به دنیای هیجان‌انگیز **مجموعه‌های کاساندرا**—لیست، ست و مپ—سفر می‌کنیم. این نوع داده‌های قدرتمند به شما امکان می‌دهند داده‌های ساختاریافته را در یک ستون ذخیره و مدیریت کنید و جداول خود را انعطاف‌پذیر و کارآمد سازید. 🚀

تا این لحظه، شما با مبانی کاساندرا، نصب، پرس‌وجوهای CQL و مدل‌سازی داده‌ها آشنا شده‌اید. در این راهنما، ما بررسی خواهیم کرد که چگونه از مجموعه‌ها برای مدیریت داده‌های پیچیده استفاده کنیم، عملیات‌هایی مانند INSERT، UPDATE، SELECT و DELETE را انجام دهیم و آن‌ها را به‌طور مؤثر پرس‌وجو کنیم. بیایید با یک مثال واقعی مجموعه‌ها را جذاب و کاربردی کنیم! 💪

---

## 📖 مقدمه‌ای بر مجموعه‌های کاساندرا

مجموعه‌های کاساندرا (لیست، ست و مپ) به شما امکان می‌دهند چندین مقدار را در یک ستون ذخیره کنید و نیاز به جداول متعدد یا اتصال‌های پیچیده را کاهش دهید. این مجموعه‌ها برای سناریوهایی که نیاز به گروه‌بندی داده‌های مرتبط دارید، مانند ایمیل‌های کاربر، نقش‌ها یا شماره‌های تماس، ایده‌آل هستند. در ادامه نگاهی مختصر به این مجموعه‌ها داریم:

- **لیست**: مجموعه‌ای مرتب از عناصر را ذخیره می‌کند و امکان تکرار دارد (مثال: `['email1', 'email2']`).
- **ست**: مجموعه‌ای نامرتب از عناصر یکتا را ذخیره می‌کند (مثال: `{'admin', 'editor'}`).
- **مپ**: جفت‌های کلید-مقدار را مانند یک دیکشنری ذخیره می‌کند (مثال: `{'home': '123456', 'mobile': '09120000000'}`).

در این راهنما، ما:
- یک جدول نمونه به نام `users` با هر سه نوع مجموعه ایجاد می‌کنیم 📝
- عملیات اصلی را انجام می‌دهیم: INSERT، SELECT، UPDATE و DELETE 🛠️
- پرس‌وجوهای پیشرفته با مجموعه‌ها را بررسی می‌کنیم (مثل دسترسی به عناصر خاص) 🔎
- بهترین شیوه‌ها و محدودیت‌ها را برجسته می‌کنیم ⚠️
- تمرین‌هایی برای تقویت درک شما ارائه می‌دهیم 🧠

بیایید شروع کنیم! 🚀

---

## 🔑 ایجاد یک جدول نمونه با مجموعه‌ها

ما یک جدول `users` برای ذخیره اطلاعات کاربر ایجاد می‌کنیم که شامل یک لیست از ایمیل‌ها، یک ست از نقش‌ها و یک مپ از شماره‌های تلفن است. این جدول زمین بازی ما برای تمام عملیات خواهد بود.

### 📦 تعریف جدول

```sql
CREATE TABLE users (
  username TEXT PRIMARY KEY,
  emails LIST<TEXT>,
  roles SET<TEXT>,
  phones MAP<TEXT, TEXT>
);
```

- **username**: کلید اصلی که هر کاربر را به‌صورت یکتا شناسایی می‌کند.
- **emails**: یک لیست برای ذخیره چندین آدرس ایمیل (مرتب، امکان تکرار دارد).
- **roles**: یک ست برای ذخیره نقش‌های کاربر (نامرتب، بدون تکرار).
- **phones**: یک مپ برای ذخیره شماره‌های تلفن با برچسب‌ها (مثل 'home'، 'mobile').

> **نکته**: مجموعه‌ها برای مجموعه داده‌های کوچک و محدود ایده‌آل هستند. از ذخیره هزاران عنصر در یک مجموعه خودداری کنید، زیرا این کار می‌تواند بر عملکرد تأثیر بگذارد. 📉

---

## 🛠️ عملیات اصلی روی مجموعه‌ها

بیایید چهار عملیات اصلی (INSERT، SELECT، UPDATE، DELETE) را روی جدول `users` انجام دهیم، با مثال‌های عملی و خروجی‌های مورد انتظار.

### ✅ ۱. INSERT — افزودن یک کاربر جدید

یک کاربر به نام 'javad' با داده‌های نمونه برای ایمیل‌ها، نقش‌ها و شماره‌های تلفن درج می‌کنیم.

```sql
INSERT INTO users (username, emails, roles, phones)
VALUES (
  'javad',
  ['javad@mail.com', 'me@example.com'],
  {'admin', 'editor'},
  {'home': '021123456', 'mobile': '09120000000'}
);
```

**چه اتفاقی می‌افتد؟**
- ما یک کاربر با دو ایمیل، دو نقش و دو شماره تلفن اضافه می‌کنیم.
- لیست (`emails`) ترتیب را حفظ کرده و امکان تکرار دارد.
- ست (`roles`) از عدم وجود تکرار اطمینان می‌دهد.
- مپ (`phones`) کلیدها (مثل 'home') را با مقادیر (مثل '021123456') مرتبط می‌کند.

---

### 🔍 ۲. SELECT — پرس‌وجو داده‌های مجموعه

بیایید داده‌هایی که درج کردیم را بخوانیم و روش‌های مختلفی برای پرس‌وجو بخش‌های خاص مجموعه‌ها را بررسی کنیم.

#### 📥 ۲.۱. دریافت تمام داده‌ها برای یک کاربر

```sql
SELECT * FROM users WHERE username = 'javad';
```

**خروجی**:

```
 username | emails                               | phones                                         | roles
----------+--------------------------------------+------------------------------------------------+---------------------
 javad    | ['javad@mail.com', 'me@example.com'] | {'home': '021123456', 'mobile': '09120000000'} | {'admin', 'editor'}
```

#### 📥 ۲.۲. دریافت اولین ایمیل از لیست

دسترسی به اولین ایمیل با استفاده از اندیس `[0]`:

```sql
SELECT emails[0] FROM users WHERE username = 'javad';
```

**خروجی**:

```
 emails[0]
------------
 javad@mail.com
```

> **توجه**: لیست‌ها از صفر شروع می‌شوند و می‌توانید به‌طور مستقیم با `[index]` به عناصر دسترسی پیدا کنید.

#### 📥 ۲.۳. دریافت یک شماره تلفن خاص از مپ

دسترسی به شماره تلفن 'home' با استفاده از کلید مپ:

```sql
SELECT phones['home'] FROM users WHERE username = 'javad';
```

**خروجی**:

```
 phones['home']
---------------
 021123456
```

#### 📥 ۲.۴. دریافت تمام کلیدهای مپ

استفاده از تابع `keys()` برای دریافت تمام کلیدهای مپ `phones`:

```sql
SELECT keys(phones) FROM users WHERE username = 'javad';
```

**خروجی**:

```
 keys(phones)
---------------
 ['home', 'mobile']
```

#### 📥 ۲.۵. دریافت تمام مقادیر مپ

استفاده از تابع `values()` برای دریافت تمام مقادیر مپ `phones`:

```sql
SELECT values(phones) FROM users WHERE username = 'javad';
```

**خروجی**:

```
 values(phones)
-------------------
 ['021123456', '09120000000']
```

#### 📥 ۲.۶. دریافت کل ست

از آنجا که ست‌ها نامرتب هستند، نمی‌توانید عناصر را با اندیس دسترسی کنید. به جای آن، کل ست را دریافت کنید:

```sql
SELECT roles FROM users WHERE username = 'javad';
```

**خروجی**:

```
 roles
---------------
 {'admin', 'editor'}
```

> **مهم**: ست‌ها از اندیس‌گذاری (مثل `roles[0]`) پشتیبانی نمی‌کنند زیرا نامرتب هستند. برای فیلتر کردن از `CONTAINS` (که بعداً توضیح داده می‌شود) استفاده کنید.

---

### 🔄 ۳. UPDATE — تغییر مجموعه‌ها

مجموعه‌ها از به‌روزرسانی‌های انعطاف‌پذیر مانند افزودن، حذف یا جایگزینی عناصر پشتیبانی می‌کنند.

#### ▶️ ۳.۱. افزودن به لیست

اضافه کردن یک ایمیل جدید به لیست `emails`:

```sql
UPDATE users SET emails = emails + ['new@mail.com'] WHERE username = 'javad';
```

**پس از به‌روزرسانی** (برای تأیید دریافت کنید):

```sql
SELECT emails FROM users WHERE username = 'javad';
```

**خروجی**:

```
 emails
--------------------------------------
 ['javad@mail.com', 'me@example.com', 'new@mail.com']
```

#### ▶️ ۳.۲. افزودن به ست

اضافه کردن یک نقش جدید به ست `roles`:

```sql
UPDATE users SET roles = roles + {'viewer'} WHERE username = 'javad';
```

**پس از به‌روزرسانی**:

```sql
SELECT roles FROM users WHERE username = 'javad';
```

**خروجی**:

```
 roles
----------------------
 {'admin', 'editor', 'viewer'}
```

> **توجه**: اگر 'viewer' از قبل وجود داشته باشد، کاساندرا آن را نادیده می‌گیرد زیرا ست‌ها تکرار را مجاز نمی‌دانند.

#### ▶️ ۳.۳. افزودن یا به‌روزرسانی یک ورودی مپ

اضافه کردن یک شماره تلفن جدید با کلید 'work':

```sql
UPDATE users SET phones['work'] = '026123456' WHERE username = 'javad';
```

**پس از به‌روزرسانی**:

```sql
SELECT phones FROM users WHERE username = 'javad';
```

**خروجی**:

```
 phones
------------------------------------------------
 {'home': '021123456', 'mobile': '09120000000', 'work': '026123456'}
```

---

### 🗑️ ۴. DELETE — حذف از مجموعه‌ها

می‌توانید عناصر خاصی را از مجموعه‌ها حذف کنید یا آن‌ها را به‌طور کامل بازنویسی کنید.

#### 🗑 ۴.۱. حذف یک عنصر از لیست

حذف ایمیل دوم (اندیس ۱):

```sql
DELETE emails[1] FROM users WHERE username = 'javad';
```

**پس از حذف**:

```sql
SELECT emails FROM users WHERE username = 'javad';
```

**خروجی**:

```
 emails
-----------------------------
 ['javad@mail.com', 'new@mail.com']
```

#### 🗑 ۴.۲. حذف یک عنصر از ست

حذف نقش 'editor':

```sql
UPDATE users SET roles = roles - {'editor'} WHERE username = 'javad';
```

**پس از حذف**:

```sql
SELECT roles FROM users WHERE username = 'javad';
```

**خروجی**:

```
 roles
---------------
 {'admin', 'viewer'}
```

#### 🗑 ۴.۳. حذف یک کلید از مپ

حذف شماره تلفن 'mobile':

```sql
DELETE phones['mobile'] FROM users WHERE username = 'javad';
```

**پس از حذف**:

```sql
SELECT phones FROM users WHERE username = 'javad';
```

**خروجی**:

```
 phones
--------------------------------------
 {'home': '021123456', 'work': '026123456'}
```

---

### 🔁 ۵. جایگزینی کامل یک مجموعه

می‌توانید یک مجموعه را به‌طور کامل بازنویسی کنید و تمام عناصر قبلی آن را حذف کنید.

#### ⛔️ جایگزینی کل لیست

تنظیم یک لیست جدید از ایمیل‌ها:

```sql
UPDATE users SET emails = ['only@mail.com'] WHERE username = 'javad';
```

**پس از جایگزینی**:

```sql
SELECT emails FROM users WHERE username = 'javad';
```

**خروجی**:

```
 emails
---------------
 ['only@mail.com']
```

> **هشدار**: جایگزینی یک Raoul مجموعه تمام داده‌های قبلی در آن ستون را حذف می‌کند. با احتیاط استفاده کنید! ⚠️

---

### 🧪 ۶. پرس‌وجوی پیشرفته با CONTAINS

برای فیلتر کردن ردیف‌ها بر اساس مقادیر مجموعه، از کلمه کلیدی `CONTAINS` استفاده کنید. با این حال، این کار نیاز به یک ایندکس روی ستون مجموعه دارد.

#### ایجاد ایندکس روی ست `roles`

```sql
CREATE INDEX ON users(roles);
```

> **توجه**: نگران ایندکس‌ها نباشید—ما در روز ششم به‌طور مفصل به آن‌ها خواهیم پرداخت! فعلاً بدانید که ایندکس پرس‌وجوهای `CONTAINS` را فعال می‌کند.

#### پرس‌وجوی کاربران با یک نقش خاص

یافتن کاربران با نقش 'admin':

```sql
SELECT * FROM users WHERE roles CONTAINS 'admin';
```

**خروجی** (با فرض اینکه فقط 'javad' نقش 'admin' را دارد):

```
 username | emails              | phones                                  | roles
----------+--------------------+-----------------------------------------+---------------
 javad    | ['only@mail.com'] | {'home': '021123456', 'work': '026123456'} | {'admin', 'viewer'}
```

#### پرس‌وجوی مپ‌ها با `CONTAINS KEY` یا `CONTAINS`

- **CONTAINS KEY**: فیلتر بر اساس کلیدهای مپ.
- **CONTAINS**: فیلتر بر اساس مقادیر مپ (نیاز به ایندکس روی مقادیر).

مثال (نیاز به ایندکس روی مقادیر `phones`):

```sql
CREATE INDEX ON users(values(phones));
SELECT * FROM users WHERE phones CONTAINS '021123456';
```

**خروجی**:

```
 username | emails              | phones                                  | roles
----------+--------------------+-----------------------------------------+---------------
 javad    | ['only@mail.com'] | {'home': '021123456', 'work': '026123456'} | {'admin', 'viewer'}
```

---

## 📊 خلاصه ویژگی‌های مجموعه‌ها

در اینجا مقایسه‌ای سریع از لیست، ست و مپ آورده شده است:

| **مجموعه** | **عملیات به‌روزرسانی**         | **قابل فیلتر؟**             | **نکات کلیدی**                             |
|-------------|---------------------------------|-----------------------------|-------------------------------------------|
| **لیست**   | افزودن، مبتنی بر اندیس، جایگزینی | خیر (فقط دسترسی به اندیس)   | مرتب، امکان تکرار دارد                    |
| **ست**     | افزودن/حذف، جایگزینی           | بله (با `CONTAINS` + ایندکس) | نامرتب، بدون تکرار                      |
| **مپ**     | افزودن/حذف بر اساس کلید، جایگزینی | بله (با `CONTAINS`/`KEY` + ایندکس) | جفت‌های کلید-مقدار، مانند دیکشنری        |

**بهترین شیوه‌ها**:
- از لیست‌ها برای داده‌های مرتب که تکرار در آن‌ها مجاز است (مثل لاگ‌های رویداد) استفاده کنید.
- از ست‌ها برای داده‌های یکتا و نامرتب (مثل برچسب‌ها یا نقش‌ها) استفاده کنید.
- از مپ‌ها برای داده‌های کلید-مقدار (مثل تنظیمات یا جزئیات تماس) استفاده کنید.
- مجموعه‌ها را کوچک نگه دارید (<۱۰۰ عنصر) تا از مشکلات عملکرد جلوگیری شود.
- ایندکس‌ها را با احتیاط استفاده کنید، زیرا هزینه نوشتن را افزایش می‌دهند.

**محدودیت‌ها**:
- مجموعه‌ها نمی‌توانند بخشی از کلید اصلی باشند.
- پرس‌وجوهای `CONTAINS` نیاز به ایندکس دارند که در روز ششم بررسی می‌کنیم.
- مجموعه‌های بزرگ می‌توانند خواندن و نوشتن را کند کنند—با دقت طراحی کنید.

---

## 🧠 تمرین‌هایی برای آزمایش مهارت‌های شما

۱. **ایجاد جدول**: یک جدول `products` با یک لیست از دسته‌بندی‌ها، یک ست از برچسب‌ها و یک مپ از ویژگی‌ها (مثل رنگ، اندازه) طراحی کنید. یک محصول نمونه درج کنید.
۲. **تمرین پرس‌وجو**: یک پرس‌وجو برای دریافت دومین دسته‌بندی از لیست جدول `products` بنویسید.
۳. **چالش به‌روزرسانی**: یک برچسب جدید به ست `tags` اضافه کنید و یک ویژگی را از مپ `attributes` حذف کنید.
۴. **پرس‌وجوی پیشرفته**: یک ایندکس روی ست `tags` ایجاد کنید و محصولاتی با یک برچسب خاص را با استفاده از `CONTAINS` پرس‌وجو کنید.